

WITH CUSTOMERS AS (
    select * from {{ref('STG_CUSTOMERS')}}
    
),
ORDERS AS (
    select * from {{ref('STG_ORDERS')}}
),
CUSTOMER_ORDERS AS (
    SELECT 
          CUSTOMER_ID,
          MIN(ORDER_DATE) AS FIRST_ORDER_DATE,
          MAX(ORDER_DATE) AS MOST_RECENT_ORDER,
          COUNT(ORDER_ID) AS NUMBER_OF_ORDERS
    FROM ORDERS
    GROUP BY CUSTOMER_ID
),
FINAL AS (
    SELECT CUSTOMERS.CUSTOMER_ID,
           CUSTOMERS.FIRST_NAME,
           CUSTOMERS.LAST_NAME,
           CUSTOMER_ORDERS.FIRST_ORDER_DATE,
           CUSTOMER_ORDERS.MOST_RECENT_ORDER,
           COALESCE(CUSTOMER_ORDERS.NUMBER_OF_ORDERS, 0) AS NUMBER_OF_ORDERS
    FROM CUSTOMERS 
    LEFT JOIN CUSTOMER_ORDERS USING (CUSTOMER_ID)
)
SELECT * FROM FINAL